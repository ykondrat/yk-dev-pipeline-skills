# URL Shortener API — Implementation Plan

> Generated by the planning phase from `spec.md` and `docs/plans/2026-02-11-url-shortener-design.md`.

## Project Overview

A REST API for creating and resolving shortened URLs with analytics, built with
Fastify, PostgreSQL (Prisma), Redis (ioredis), and TypeScript in strict mode.

## File Structure

```
url-shortener-api/
├── src/
│   ├── config/
│   │   └── env.ts                  # Environment variable validation (Zod)
│   ├── types/
│   │   ├── url.types.ts            # URL domain types
│   │   └── analytics.types.ts      # Analytics domain types
│   ├── domain/
│   │   ├── url/
│   │   │   ├── url.service.ts      # URL shortening/resolving business logic
│   │   │   └── url.repository.ts   # Database access for URLs
│   │   └── analytics/
│   │       ├── analytics.service.ts    # Click tracking & stats
│   │       └── analytics.repository.ts # Database access for analytics
│   ├── infrastructure/
│   │   ├── database.ts             # Prisma client setup & connection
│   │   ├── cache.ts                # Redis connection & helpers
│   │   └── id-generator.ts         # Short code generation (nanoid)
│   ├── api/
│   │   ├── routes/
│   │   │   ├── url.routes.ts       # URL CRUD endpoints
│   │   │   ├── analytics.routes.ts # Analytics endpoints
│   │   │   └── health.routes.ts    # Health check endpoint
│   │   ├── middleware/
│   │   │   ├── rate-limiter.ts     # Rate limiting via Redis
│   │   │   └── error-handler.ts    # Centralized error handling
│   │   └── schemas/
│   │       ├── url.schema.ts       # Request validation schemas (TypeBox)
│   │       └── analytics.schema.ts # Analytics query schemas
│   ├── lib/
│   │   ├── errors.ts               # Custom error classes
│   │   └── logger.ts               # Pino logger setup
│   └── app.ts                      # Fastify app factory
│   └── server.ts                   # Entry point with graceful shutdown
├── prisma/
│   ├── schema.prisma               # Database schema
│   └── migrations/                 # Generated migrations
├── .env.example
├── tsconfig.json
└── package.json
```

## Tasks

### Task 1: Project scaffolding
- **Files**: `package.json`, `tsconfig.json`, `.env.example`, `.gitignore`
- **Depends on**: —
- **Description**: Initialize Node.js project with TypeScript strict mode, install core dependencies (fastify, prisma, ioredis, pino, zod, nanoid).
- **Acceptance criteria**: `npx tsc --noEmit` passes with empty src/. All dependencies in package.json.
- **Notes**: Use `"type": "module"` in package.json for ESM.

### Task 2: Configuration & environment
- **Files**: `src/config/env.ts`, `.env.example`
- **Depends on**: Task 1
- **Description**: Create Zod schema for all env vars. Validate at import time. Export typed config object.
- **Acceptance criteria**: App crashes with clear error if `DATABASE_URL`, `REDIS_URL`, or `PORT` missing. `.env.example` documents all variables.
- **Notes**: Include `BASE_URL` for constructing short URLs, `RATE_LIMIT_MAX` and `RATE_LIMIT_WINDOW_MS`.

### Task 3: Database schema & connection
- **Files**: `prisma/schema.prisma`, `src/infrastructure/database.ts`
- **Depends on**: Task 2
- **Description**: Define `Url` and `Click` models in Prisma. Create database plugin for Fastify.
- **Acceptance criteria**: `npx prisma migrate dev` runs cleanly. Database connection tested in health check. Schema matches spec: Url (id, shortCode, originalUrl, createdAt, expiresAt, clickCount), Click (id, urlId, timestamp, referrer, userAgent, ip).
- **Notes**: Index on `shortCode` (unique), index on `Click.urlId` + `Click.timestamp`.

### Task 4: Redis connection & cache helpers
- **Files**: `src/infrastructure/cache.ts`
- **Depends on**: Task 2
- **Description**: Create ioredis connection with retry logic. Implement cache-aside helpers: `get<T>`, `set`, `del`, `getOrSet`. Create Fastify plugin.
- **Acceptance criteria**: Redis connection tested in health check. Graceful degradation if Redis unavailable (log warning, skip cache, don't crash).
- **Notes**: Key prefix: `url-shortener:`. Default TTL: 1 hour.

### Task 5: Error handling & logging
- **Files**: `src/lib/errors.ts`, `src/lib/logger.ts`, `src/api/middleware/error-handler.ts`
- **Depends on**: Task 1
- **Description**: Define AppError hierarchy (NotFoundError, ConflictError, ValidationError, RateLimitError). Set up Pino structured logging. Create Fastify error handler that maps errors to HTTP responses.
- **Acceptance criteria**: All errors return consistent JSON format: `{ error: { code, message, details? } }`. Unexpected errors return 500 without leaking internals. All errors logged with context.
- **Notes**: —

### Task 6: URL shortening service
- **Files**: `src/domain/url/url.service.ts`, `src/domain/url/url.repository.ts`, `src/infrastructure/id-generator.ts`, `src/types/url.types.ts`
- **Depends on**: Tasks 3, 4, 5
- **Description**: Implement URL creation (generate short code via nanoid, store in DB, cache), URL resolution (check cache first, fall back to DB, cache result), URL deletion. Handle collisions by retrying with new code (max 3 attempts).
- **Acceptance criteria**: Short codes are 7 chars by default. Duplicate original URLs return existing short URL. Resolution is cache-first. Expired URLs return 410 Gone.
- **Notes**: Short code charset: `[a-zA-Z0-9]`.

### Task 7: Analytics service
- **Files**: `src/domain/analytics/analytics.service.ts`, `src/domain/analytics/analytics.repository.ts`, `src/types/analytics.types.ts`
- **Depends on**: Tasks 3, 6
- **Description**: Record click events (fire-and-forget, don't slow down redirect). Query analytics: total clicks, clicks over time (hourly/daily), top referrers, top user agents.
- **Acceptance criteria**: Click recording doesn't block the redirect response. Analytics queries support date range filtering. Increment URL `clickCount` atomically.
- **Notes**: Use `Promise.allSettled` for fire-and-forget click recording so errors are caught.

### Task 8: API routes
- **Files**: `src/api/routes/url.routes.ts`, `src/api/routes/analytics.routes.ts`, `src/api/routes/health.routes.ts`, `src/api/schemas/url.schema.ts`, `src/api/schemas/analytics.schema.ts`
- **Depends on**: Tasks 6, 7
- **Description**: Implement endpoints per spec: `POST /api/v1/urls` (create), `GET /:code` (redirect 302), `GET /api/v1/urls/:code` (get URL details), `DELETE /api/v1/urls/:code` (delete), `GET /api/v1/urls/:code/analytics` (stats), `GET /health` (health check). Validate all inputs with TypeBox schemas.
- **Acceptance criteria**: All endpoints return correct status codes. Input validation returns 400 with field-level errors. Redirect is 302 with `Location` header.
- **Notes**: Redirect endpoint is at root (not under /api) for short URLs.

### Task 9: Rate limiting
- **Files**: `src/api/middleware/rate-limiter.ts`
- **Depends on**: Task 4
- **Description**: Implement sliding window rate limiting via Redis sorted sets. Apply to URL creation endpoint (stricter) and redirect endpoint (lenient). Return `Retry-After` header when limited.
- **Acceptance criteria**: Rate limit headers present on all responses (`X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`). Returns 429 when exceeded. Configurable via env vars.
- **Notes**: Gracefully degrade if Redis is down (allow all requests, log warning).

### Task 10: App assembly & entry point
- **Files**: `src/app.ts`, `src/server.ts`
- **Depends on**: Tasks 5, 8, 9
- **Description**: Wire everything together in Fastify app factory. Add CORS, helmet, request logging. Create server entry point with graceful shutdown (drain connections, close DB + Redis).
- **Acceptance criteria**: `npm run build && npm start` starts the server. SIGTERM/SIGINT trigger clean shutdown. All connections closed on exit.
- **Notes**: —

## Dependencies Between Tasks

```
Task 1 → Task 2 → Task 3 → Task 6 → Task 7 → Task 8 → Task 10
              ↘ Task 4 → Task 9 ↗                   ↗
              ↘ Task 5 ────────────────────────────↗
```

## Implementation Order (batches)

- **Batch 1** (Tasks 1, 5): Scaffolding + error infrastructure
- **Batch 2** (Tasks 2, 3, 4): Config + database + Redis
- **Batch 3** (Tasks 6, 7): Domain services
- **Batch 4** (Tasks 8, 9, 10): API layer + assembly

## Risk Notes

- Short code collision: nanoid 7 chars ≈ 3.5 trillion combinations. Retry logic covers edge case.
- Redis failure: Must not crash the app. Cache is optimization, not requirement.
- Click recording: Must be non-blocking. A failed click record should never affect user redirect.
