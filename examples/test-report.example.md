# Test Report — URL Shortener API

> Generated by the testing phase.

## Summary

| Metric | Value |
|---|---|
| Test runner | Vitest 2.1.0 |
| Total test files | 9 |
| Total tests | 47 |
| Passing | 45 |
| Failing | 2 |
| Skipped | 0 |
| Duration | 4.2s |

## Coverage

| Metric | Value | Threshold | Status |
|---|---|---|---|
| Statements | 87.3% | 80% | ✅ |
| Branches | 82.1% | 80% | ✅ |
| Functions | 91.0% | 80% | ✅ |
| Lines | 88.5% | 80% | ✅ |

## Test Breakdown by File

### Unit Tests

| File | Tests | Pass | Fail | Coverage |
|---|---|---|---|---|
| `src/domain/url/url.service.test.ts` | 12 | 12 | 0 | 94% |
| `src/domain/analytics/analytics.service.test.ts` | 6 | 6 | 0 | 88% |
| `src/infrastructure/id-generator.test.ts` | 3 | 3 | 0 | 100% |
| `src/infrastructure/cache.test.ts` | 5 | 5 | 0 | 85% |
| `src/api/middleware/rate-limiter.test.ts` | 4 | 4 | 0 | 90% |
| `src/api/middleware/error-handler.test.ts` | 3 | 3 | 0 | 100% |
| `src/config/env.test.ts` | 4 | 4 | 0 | 100% |

### Integration / API Tests

| File | Tests | Pass | Fail | Coverage |
|---|---|---|---|---|
| `tests/api/url.routes.test.ts` | 8 | 6 | 2 | 82% |
| `tests/api/health.routes.test.ts` | 2 | 2 | 0 | 100% |

## Failing Tests

### FAIL: `tests/api/url.routes.test.ts` — "should return 410 Gone for expired URL"

```
AssertionError: expected 404 to be 410

  Expected: 410
  Received: 404

  at tests/api/url.routes.test.ts:87:34
```

**Root cause**: The `resolve()` method throws `NotFoundError` for both missing and expired
URLs. It should throw a distinct `GoneError` (410) for expired URLs.

**Fix required**: In `url.service.ts:resolve()`, check `url.expiresAt < new Date()` separately
and throw `GoneError` instead of `NotFoundError`.

---

### FAIL: `tests/api/url.routes.test.ts` — "should handle concurrent creation of same URL"

```
Error: Prisma unique constraint violation on `Url.shortCode`

  at tests/api/url.routes.test.ts:112:5
```

**Root cause**: The collision retry logic in `url.service.ts:create()` catches generic
Prisma errors but doesn't specifically check for `P2002` (unique constraint) on `shortCode`.
When two requests create the same URL simultaneously, the duplicate check passes for both
(no existing URL), and the second insert fails.

**Fix required**: In the catch block of `create()`, check for Prisma error code `P2002` on
`shortCode` field and retry with a new code. The existing retry loop supports this — just
need to add the error code check.

---

## Fix Attempts

Both failures were discovered on the first test run. After investigation:

- **Expired URL (410)**: Requires a code change in `url.service.ts` + new `GoneError` class.
  This is a logic bug, not a test issue.
- **Concurrent creation**: Requires a Prisma error code check in the retry logic.
  This is a missing edge case in implementation.

These issues are documented in `fix-test-plan.md` for the implementation phase to resolve.

## Tests by Category

### Happy Path (18 tests) — all passing
- URL creation, resolution, deletion
- Analytics recording and querying
- Health check
- Configuration loading

### Edge Cases (12 tests) — all passing
- Empty input handling
- Maximum URL length (2048 chars)
- Short code charset validation
- Pagination with zero results
- Redis unavailable (graceful degradation)

### Error Paths (10 tests) — all passing
- Invalid input validation (400)
- URL not found (404)
- Rate limit exceeded (429)
- Duplicate URL handling
- Database connection failure

### Concurrency & Performance (5 tests) — 2 failing
- Concurrent URL creation (FAILING)
- Expired URL resolution (FAILING — logic bug, not concurrency)
- Rate limiter under concurrent requests (passing)
- Bulk URL creation performance (passing)
- Redirect latency benchmark < 50ms (passing)

### Security (2 tests) — all passing
- URL validation rejects javascript: protocol
- Rate limiting enforced per IP
