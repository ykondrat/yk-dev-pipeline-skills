# Fix Test Plan — URL Shortener API

> Generated by the testing phase when tests fail and the user chooses to loop back
> to implementation. Read this file during the implementation phase to fix test failures.

## Context

2 of 47 tests are failing. Both are implementation bugs (not test issues).
The testing phase has verified the tests are correct — the code needs to change.

## Fixes Required

### Fix 1: Return 410 Gone for expired URLs

**Failing test**: `tests/api/url.routes.test.ts` — "should return 410 Gone for expired URL"

**Root cause**: `url.service.ts:resolve()` throws `NotFoundError` for expired URLs instead
of a distinct `GoneError` with HTTP 410.

**Changes needed**:

1. **Create `GoneError`** in `src/lib/errors.ts`:
   ```typescript
   export class GoneError extends AppError {
     constructor(message: string) {
       super('GONE', 410, message);
     }
   }
   ```

2. **Update `url.service.ts:resolve()`** — after finding the URL, check expiration:
   ```typescript
   if (url.expiresAt && url.expiresAt < new Date()) {
     throw new GoneError(`URL ${code} has expired`);
   }
   ```
   This check must come **after** the null check (NotFoundError) and **before** returning
   the URL / caching it.

3. **Update `error-handler.ts`** — ensure `GoneError` maps to 410 (should work automatically
   if it extends `AppError` with statusCode 410).

**Acceptance**: Test passes. Expired URLs return `{ error: { code: "GONE", message: "..." } }`
with HTTP 410.

---

### Fix 2: Handle unique constraint violation in concurrent creation

**Failing test**: `tests/api/url.routes.test.ts` — "should handle concurrent creation of same URL"

**Root cause**: `url.service.ts:create()` has a retry loop for short code collisions, but
the catch block doesn't check for Prisma's unique constraint error code `P2002`.

**Changes needed**:

1. **Update catch block in `url.service.ts:create()`**:
   ```typescript
   import { Prisma } from '@prisma/client';

   // In the retry loop catch:
   if (
     error instanceof Prisma.PrismaClientKnownRequestError &&
     error.code === 'P2002' &&
     (error.meta?.target as string[])?.includes('shortCode')
   ) {
     // Short code collision — retry with new code
     continue;
   }
   // Not a collision — rethrow
   throw error;
   ```

2. **No other files need changes** — the retry loop structure already exists, it just
   needs to recognize this specific error.

**Acceptance**: Test passes. Concurrent creation of the same URL either returns the
existing URL or creates with a different short code (no 500 error).

---

## After Fixing

Re-run the full test suite:
```bash
npm test
```

All 47 tests should pass. If they do, update `pipeline-state.json` testing status to
`"completed"` and proceed to the documentation phase.
