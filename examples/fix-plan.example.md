# Fix Plan — URL Shortener API

> Generated by the code-review phase from `review.md` findings.
> Read this file during the implementation phase to apply fixes.

## Priority Fixes (Minor — recommended before testing)

### Fix 1: Add timeout on redirect DB fallback [CR-001]
- **File**: `src/domain/url/url.service.ts`
- **What**: Wrap the Prisma fallback query in `resolve()` with a 3-second timeout.
- **How**: Create a `withTimeout` utility in `src/lib/utils.ts` or use `AbortController` with Prisma.
- **Acceptance**: Redirect returns 504 if DB takes longer than 3 seconds.

### Fix 2: Clean up expired rate limit entries [CR-002]
- **File**: `src/api/middleware/rate-limiter.ts`
- **What**: Add `ZREMRANGEBYSCORE` call before `ZCARD` to remove entries outside the window.
- **How**: Add one Redis command before the count operation.
- **Acceptance**: Sorted set size stays bounded. Existing rate limit tests still pass.

### Fix 3: Log failed click recordings [CR-003]
- **File**: `src/domain/analytics/analytics.service.ts`
- **What**: Add `.then()` handler on the `Promise.allSettled` call to log rejected results.
- **How**: Iterate results, log `warn` for any `rejected` status.
- **Acceptance**: Failed click recordings appear in logs with URL ID context.

### Fix 4: Report Redis in health check [CR-004]
- **File**: `src/api/routes/health.routes.ts`
- **What**: Add Redis ping to health check. Return `"degraded"` status if Redis is down.
- **How**: Add `redis.ping()` wrapped in try/catch. Return 200 with `"degraded"` status.
- **Acceptance**: Health check returns `{ status: "healthy" | "degraded", checks: { database, redis } }`.

## Optional Fixes (Nitpick — apply if time permits)

### Fix 5: Extract SHORT_CODE_LENGTH constant [CR-006]
- **File**: `src/infrastructure/id-generator.ts`
- **What**: Replace magic number `7` with named constant.

### Fix 6: Normalize BASE_URL trailing slash [CR-007]
- **File**: `src/config/env.ts`
- **What**: Add `.transform()` to strip trailing slash from BASE_URL.

### Fix 7: Validate expiresAt is in the future [CR-008]
- **File**: `src/api/schemas/url.schema.ts`
- **What**: Add custom validation that `expiresAt > now`.

### Fix 8: Consistent import ordering [CR-005]
- **Files**: `src/domain/url/url.service.ts`, `src/domain/analytics/analytics.service.ts`
- **What**: Reorder imports: external → internal → types, with blank lines between groups.

### Fix 9: Randomize factory short codes [CR-011]
- **File**: `tests/factories.ts`
- **What**: Use `nanoid(7)` instead of hardcoded `'abc1234'` in `buildUrl()`.

## Skipped (No Action Needed)

- [CR-009] DELETE without ownership — by design per spec (no auth). Noted for future.
- [CR-010] Missing JSDoc — defer to documentation phase.
- [CR-012] ioredis deviation — classified as justified improvement.
- [CR-013] Nanoid over CUID2 — classified as acceptable trade-off.

## Estimated Effort

Priority fixes: ~15 minutes
Optional fixes: ~10 minutes
